<?php

/**
 * @file
 * Module file cho Dseza API.
 */

 

/**
 * Implements hook_page_attachments().
 */
function dseza_api_page_attachments(array &$attachments) {
  // Note: CORS headers được xử lý trong Event Subscriber
  // Không thể set response headers trong hook_page_attachments()
  // Xem EventSubscriber/CorsEventSubscriber.php
}

/**
 * Ghi chú: Hàm dseza_api_init() đã được loại bỏ.
 *
 * Lý do: Xử lý CORS và preflight OPTIONS đã được chuyển hoàn toàn sang
 * Event Subscriber `Drupal\\dseza_api\\EventSubscriber\\CorsEventSubscriber`,
 * bảo đảm an toàn và đúng luồng xử lý response trong Symfony/Drupal.
 * Không nên gửi headers/response trực tiếp trong hook_init() ở Drupal 8+.
 */

/**
 * Implements hook_mail().
 */
function dseza_api_mail($key, &$message, $params) {
  switch ($key) {
    case 'contact_form':
      $message['subject'] = $params['subject'];
      $message['body'][] = $params['body'];
      
      // Thiết lập header
      $message['headers']['Content-Type'] = 'text/plain; charset=UTF-8';
      $message['headers']['From'] = $params['from_name'] . ' <' . $params['from'] . '>';
      // Thiết lập Reply-To an toàn để tránh header injection và chỉ set khi email hợp lệ.
      if (!empty($params['headers']['Reply-To'])) {
        $raw_reply_to = str_replace(["\r", "\n"], '', (string) $params['headers']['Reply-To']);
        $reply_to_name = '';
        $reply_to_email = '';

        if (preg_match('/^(.*)<([^<>]+)>$/', $raw_reply_to, $matches)) {
          $reply_to_name = trim($matches[1], " \t\"'\0");
          $reply_to_name = preg_replace('/[\r\n<>]/', '', $reply_to_name);
          $reply_to_email = trim($matches[2]);
        }
        else {
          $reply_to_email = trim($raw_reply_to);
        }

        if (filter_var($reply_to_email, FILTER_VALIDATE_EMAIL)) {
          $message['headers']['Reply-To'] = $reply_to_name !== ''
            ? ($reply_to_name . ' <' . $reply_to_email . '>')
            : $reply_to_email;
        }
      }
      elseif (!empty($params['from']) && filter_var($params['from'], FILTER_VALIDATE_EMAIL)) {
        // Fallback: dùng from nếu hợp lệ.
        $message['headers']['Reply-To'] = str_replace(["\r", "\n"], '', $params['from']);
      }
      
      break;
  }
} 

/**
 * Implements hook_language_negotiation_info_alter().
 *
 * Replace the core URL negotiator with our variant that skips API paths.
 */
function dseza_api_language_negotiation_info_alter(array &$negotiation_info) {
  if (isset($negotiation_info['language-url'])) {
    $negotiation_info['language-url']['class'] = 'Drupal\\dseza_api\\Plugin\\LanguageNegotiation\\NoApiLanguageNegotiationUrl';
  }
}